/*
    NPF images fix v4.0 by @glenthemes [2026]
    github.com/glenthemes/npf-images-v4
*/
window.NPFv4=e=>{let t=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),o="[post-type]:not(.npf-loaded)",l="[post-type='text']:not(.npf-loaded)";function r(e){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}function s(e){let t=getComputedStyle(document.documentElement).getPropertyValue(e).trim().replace(/^['"]|['"]$/g,"");return""===t?void 0:t}let i=e=>{function r(){return{textBlock:s("--NPF-Text-Container")??"",reblogs:s("--NPF-Reblogs-Selector")??"",moveToTop:s("--NPF-Move-To-Top")??"no",addSource:s("--NPF-Captionless-Add-Source")??"yes",changePostType:s("--NPF-Change-Post-Type")??"no"}}let i=r();function n(e,t,o,l){let r=[],s=e.querySelectorAll(`:scope > ${t}`),i=0,n=s.length;s?.forEach(e=>{if(!e.previousElementSibling?.matches(t)){let s=document.createElement(o.tag);if(Array.isArray(o.className))for(let p of o.className)s.classList.add(p);else s.classList.add(o.className);e.before(s);let c=s.nextElementSibling;for(c&&(!c||c.matches(t))||s.remove(),c&&r.push(s);c&&c.matches(t);)s.append(c),c=s.nextElementSibling}++i===n&&l&&"function"==typeof l&&l(r)})}function p(e){return""!==e&&null!==document.querySelector(e)}function c(e,t){let o=document.createElement("div");if(o.classList.add("npf_col"),!e||!e.wrap)return o;e.wrap.before(o),o.append(e.wrap),t?.(o)}function d(e,t){let o=document.createElement("div");if(o.classList.add("tmblr-full"),!e||!e.wrap)return o;e.wrap.before(o),o.append(e.wrap),t?.(o)}function f(e,t){let o=t.addType,l;!e.matches(".tmblr-full")&&e.closest(".tmblr-full")?l=e.closest(".tmblr-full"):e.matches(".tmblr-full")||e.closest(".tmblr-full")?l=e:d({wrap:e},e=>{l=e}),l.closest(".npf_row")||h({wrap:l,addType:o})}function h(e,t){let o=document.createElement("div");if(o.classList.add("npf_row"),e&&e.addType){if(Array.isArray(e.addType))for(let l of e.addType)o.classList.add(`npf_${l}`);else o.classList.add(`npf_${e.addType}`)}if(!e||!e.wrap)return o;e.wrap.before(o),o.append(e.wrap),t?.(o)}function u(e,t){if(console.log(e),e&&t&&i.changePostType&&("yes"==i.changePostType||!0===i.changePostType)){let o=t.getAttribute("class");e.setAttribute("post-type",o.indexOf("npf_photo")>-1?"photo":o.indexOf("npf_audio")>-1?"audio":o.indexOf("npf_video")>-1?"video":o.indexOf("npf_multimedia")>-1?"multimedia":"text"),e.classList.add("previously-npf")}}function m(){"aspect-ratio"in document.documentElement.style?g?.():y?.()}function g(){document.querySelectorAll(".npf_photo_row:not(.npf-loaded [data-npf-row-ready]):has(.npf_col + .npf_col)")?.forEach(e=>{let t=[],o=[],l=".npf_col:not(.npf_col .npf_col)";if(e.querySelectorAll(l)?.forEach(e=>{let l=e.querySelector("[data-big-photo-width][data-big-photo-height]")||e.querySelector("[data-orig-width][data-orig-height]");if(l){let r;if(l.matches("[data-big-photo-width][data-big-photo-height]")?r="big-photo":l.matches("[data-orig-width][data-orig-height]")&&(r="orig"),l&&""!==l.getAttribute(`data-${r}-width`).trim()&&""!==l.getAttribute(`data-${r}-height`).trim()){let s=Number(l.getAttribute(`data-${r}-width`)),i=Number(l.getAttribute(`data-${r}-height`));if(isNaN(s)||isNaN(i))return;t.push(s/i),o.push(`${s}/${i}`)}}}),t.length==e.querySelectorAll(l).length){let r=Math.max(...t),s=o[t.findIndex(e=>e===r)];e.querySelectorAll(l)?.forEach(e=>e.style.aspectRatio=s),e.dataset.npfRowReady=""}})}function y(){document.querySelectorAll(".npf_photo_row[columns]:not(.npf-loaded [data-npf-row-ready], [columns='1'], [columns=''], [columns='0'])")?.forEach(e=>{let t=e.querySelectorAll(":scope > .npf_col").length,o=[],l=[],r=[];e.querySelectorAll(":scope > .npf_col img:first-of-type")?.forEach(s=>{let i,n,p;function c(s,i,n){if(o.push(s),l.push(i),r.push(n),o.length==t){let p=Math.max(...r),c=r.findIndex(e=>e==p),d=o[c],f=l[c];e.style.setProperty("--npf-img-pct",`${f/d*100}%`),e.dataset.npfHeight="",e.dataset.npfRowReady=""}}s.complete?(p=(i=s.naturalWidth)/(n=s.naturalHeight),c(i,n,p)):s.addEventListener("load",e=>{p=(i=e.target.naturalWidth)/(n=e.target.naturalHeight),c(i,n,p)})})})}if(!document.querySelector("[post-type='text']")&&document.querySelector('script[src*="assets.tumblr.com/assets/scripts/customize"]')&&!document.getElementById("npf-v4-reminder")){let b=document.createElement("div");if(b.id="npf-v4-reminder",b.innerHTML='<b>NPF v4</b> warning: <code>post-type="{PostType}"</code> does not appear to be present in your theme. <a href="https://github.com/glenthemes/npf-images-v4?tab=readme-ov-file#step-3-add-post-typeposttype-to-your-posts" target="_blank">Please add it to your posts selector</a> to get it working!',!document.querySelector('link[href*="//assets.tumblr.com/fonts/favorit/stylesheet.css"][rel="stylesheet"]')){let S=document.createElement("link");S.href="https://assets.tumblr.com/fonts/favorit/stylesheet.css",S.rel="stylesheet",document.head.append(S)}document.body.append(b)}for(let w of document.querySelectorAll(`${o} p > br:only-child`))[...w.closest("p").childNodes]?.forEach(e=>{if(3===e.nodeType&&e.data.trim().length){let t=document.createElement("span");e.before(t),t.appendChild(e)}});for(let L of document.querySelectorAll(`${o} p`))""==L.innerHTML.trim()&&L.remove();for(let q of document.querySelectorAll(`${o} figure:not([class])`))q.querySelector("img")&&q.classList.add("tmblr-full");for(let v of document.querySelectorAll(`${o} .npf_row .tmblr-full:not(:only-of-type):not(.npf_col > .tmblr-full)`))c({wrap:v});for(let A of document.querySelectorAll(`${o} [data-npf*='"type":"video"'], ${o} .tmblr-embed.tmblr-full`))f(A,{addType:"video_row"});for(let T of document.querySelectorAll(`${o} [data-npf*='"type":"audio"'], ${o} iframe[class*="_audio_player"], ${o} .tmblr-full > figcaption.audio-caption`))f(T,{addType:"audio_row"});for(let E of document.querySelectorAll(`${o} figure[data-orig-src] > img:first-child`)){let x=E.closest("figure[data-orig-src]");if(x.matches(".tmblr-full")||x.classList.add("tmblr-full"),E.matches("[data-orig-width][data-orig-height]")){let H=E.dataset.origWidth,M=E.dataset.origHeight,P=document.createElement("a");P.classList.add("post_media_photo_anchor"),P.dataset.bigPhoto=E.src,P.dataset.bigPhotoWidth=H,P.dataset.bigPhotoHeight=M,E.classList.add("post_media_photo","image"),E.before(P),P.append(E)}x.closest(".npf_row")||h({wrap:x,addType:"photo_row"})}for(let N of document.querySelectorAll(`${o} .tmblr-full:not(.npf_row .tmblr-full) > a.post_media_photo_anchor > img.post_media_photo`))h({wrap:N.closest(".tmblr-full:not(.npf_row .tmblr-full)"),addType:"photo_row"});for(let k of document.querySelectorAll(`${o} .tmblr-full[data-tumblr-attribution] > img`)){let _=k.closest(".tmblr-full");k.matches(".post_media_image")||k.classList.add("post_media_image");let C;if(!k.closest("a.post_media_photo_anchor")&&_.matches("[data-orig-width]:not([data-orig-width=''])[data-orig-height]:not([data-orig-height=''])")){let W=document.createElement("a");W.classList.add("post_media_photo_anchor"),W.dataset.bigPhotoWidth=_.dataset.origWidth,W.dataset.bigPhotoHeight=_.dataset.origHeight,_.before(W),W.append(_),C=W}else C=a;C.closest(".npf_row")?C.closest(".npf_row").classList.add("npf_photo_row"):h({wrap:C,addType:"photo_row"})}for(let O of document.querySelectorAll(`${o} .npf_row > .npf_col:only-child`))O.replaceWith(...O.childNodes);for(let F of document.querySelectorAll(`${o} .npf_row > .npf_col + .npf_col`))F.closest(".npf_row").classList.add("npf_photo_row");for(let B of document.querySelectorAll(`${o} .npf_row > .tmblr-full > a.post_media_photo_anchor > img.post_media_photo`))B.closest(".npf_row").classList.add("npf_photo_row");let R=["npf_photo_row","npf_video_row","npf_audio_row"];for(let I of document.querySelectorAll(`${o} .npf_row:first-of-type:not(.npf_row .npf_row, .npf_inst .npf_row)`)){let j=I.parentNode;j&&n(j,".npf_row",{tag:"div",className:"npf_inst"},e=>{for(let t of e){let o=[];for(let l of t.children)l.matches(".npf_row")&&o.push(l.classList.value.split(" ").filter(e=>"npf_row"!==e));if(1==o.length){let r=o[0];for(let s of R)r.includes(s)&&(t.classList.add(s.substring(0,s.lastIndexOf("_row"))+(t.querySelector(".npf_col")?"_set":"_single")),r=r.filter(e=>e!==s))}else if(o.length>1)for(let i=0;i<o.length-1;i++){let p=o[i],c=o[i+1],d=p.filter(e=>c.includes(e));d.length?"npf_photo_row"==d[0]?t.classList.add("npf_photo_set"):"npf_audio_row"==d[0]?t.classList.add("npf_audio_set"):"npf_video_row"==d[0]&&t.classList.add("npf_video_set"):(t.classList.add("npf_multimedia"),n(t,".npf_photo_row",{tag:"div",className:["npf_row_set","npf_photo_set"]}))}}})}for(let Q of document.querySelectorAll(`${o} .npf_row.npf_photo_row`)){let z=Q.querySelectorAll(".npf_col:not(.npf_col .npf_col)")?.length;Q.setAttribute("columns",z||1)}for(let D of(m(),document.querySelectorAll(`${o} .npf_col`)))D.dataset.ready="";for(let U of document.querySelectorAll(`${o} .npf_photo_set, ${o} .npf_photo_single`))if(U.querySelector("img")){let V=[];U.querySelectorAll("img").forEach((e,o)=>{let l=e.closest("a.post_media_photo_anchor");l&&l.matches("[data-big-photo]")&&l.removeAttribute("data-big-photo");let r,s,i,n;if(e.matches("[srcset]")){let p=e.getAttribute("srcset");i=e.src,n=p.split(",").pop().trim().split(" ")[0];let c=new Image;c.src=n,r=c.width,s=c.height,r>=.9*t&&(r*=.7,s*=.7)}else{i=e.src,n=e.src;let d=e.closest("[data-big-photo-width]"),f=e.closest("[data-big-photo-height]");r=d?Number(d.getAttribute("data-big-photo-width")):e.width,s=f?Number(f.getAttribute("data-big-photo-height")):e.height}V.push({width:r,height:s,low_res:i,high_res:n});let h=Math.floor(parseInt(o)+1);e.setAttribute("img-index",h),e.addEventListener("click",()=>{Tumblr.Lightbox.init(V,h)})})}if("yes"==i.moveToTop||!0===i.moveToTop){let G=i.textBlock,J=p(G),K=i.reblogs,X=p(K);if((window.jQuery||window.$)&&$().unnest){if(J&&!p(K))for(let Y of document.querySelectorAll(`${l} ${G} .npf_inst`)){let Z=Y.closest("[post-type='text']"),ee=Y.previousElementSibling,et=Y.nextElementSibling,eo=Y.closest(G);(!ee||ee&&""==ee.innerHTML.trim())&&(Y.classList.add("photo-origin"),u(Z,Y),eo.before(Y),eo.classList.add("npf-caption"),(!et||et&&""==et.innerHTML.trim())&&(Y.classList.add("npf-no-caption"),eo.remove()))}else if(p(K))for(let el of document.querySelectorAll(`${l} ${K}:not(:is(${K} ~ ${K})) .npf_inst`)){let er=el.closest("[post-type='text']"),es=J?el.closest(G):el.closest(K),ei=el.closest(K),ea=el.previousElementSibling,en=el.nextElementSibling,ep=ea&&""==ea.innerHTML.trim(),ec=ea&&(ea.matches("a.tumblr_blog")||ea.matches("a[href*='tumblr.com/']"));if((!ea||ep||ec)&&(el.classList.add("photo-origin"),u(er,el),es.before(el),es.classList.add("npf-caption"),!en||en&&""==en.innerHTML.trim())){if(el.classList.add("npf-no-caption"),"yes"==i.addSource||!0===i.addSource){let ed=es.querySelector("a[href*='tumblr.com/']");if(ed){let ef=ed.cloneNode(!0);if(ef.matches("[class]")&&ef.removeAttribute("class"),""!==ef.textContent.trim()){let eh=document.createElement("p");if(eh.classList.add("npf-post-source"),eh.append(ef),eh.innerHTML=`(Source: ${eh.innerHTML})`,es!==ei)es.append(eh),ei.remove();else{let eu=ei.parentNode.querySelector(`:scope > ${K}:last-of-type`);eu&&(eu.after(eh),ei.remove())}}}}else ei.remove()}}}else if(K){if(K)for(let em of document.querySelectorAll(`${l} .npf_inst`)){let eg=em.closest("[post-type='text']");if(em.closest(K)){let e8=J?em.closest(G):em.closest(K),ey=em.closest(K);if(ey.matches(`${l} ${K}:not(:is(${K} ~ ${K}))`)){let eb=em.previousElementSibling,eS=em.nextElementSibling,ew=eb&&""==eb.innerHTML.trim(),eL=eb&&(eb.matches("a.tumblr_blog")||eb.matches("a[href*='tumblr.com/']"));if((!eb||ew||eL)&&!eg.querySelector(".photo-origin")&&(em.classList.add("photo-origin"),u(eg,em),e8.before(em),e8.classList.add("npf-caption"),!eS||eS&&""==eS.innerHTML.trim())){let eq=ey.querySelector("a[href*='tumblr.com/']");if(em.classList.add("npf-no-caption"),"yes"==i.addSource||!0===i.addSource){if(eq){let ev=eq.cloneNode(!0);if(ev.matches("[class]")&&ev.removeAttribute("class"),""!==ev.textContent.trim()){let eA=document.createElement("p");if(eA.classList.add("npf-post-source"),eA.append(ev),eA.innerHTML=`(Source: ${eA.innerHTML})`,e8!==ey)e8.append(eA),ey.remove();else{let e9=ey.parentNode.querySelector(`:scope > ${K}:last-of-type`);e9&&(e9.after(eA),ey.remove())}}}}else ey.remove()}}}else{let eT=em.closest(G);if(eT){let eE=em.previousElementSibling,ex=em.nextElementSibling,eH=eE&&""==eE.innerHTML.trim(),e$=eE&&(eE.matches("a.tumblr_blog")||eE.matches("a[href*='tumblr.com/']"));(!eE||eH||e$)&&(em.classList.add("photo-origin"),u(eg,em),eT.before(em),eT.classList.add("npf-caption"),(!ex||ex&&""==ex.innerHTML.trim())&&(em.classList.add("npf-no-caption"),eT.remove()))}}}}else for(let eM of document.querySelectorAll(`${l} .npf_inst`)){let eP=eM.closest("[post-type='text']"),eN=eM.closest(G);if(!eN)return;for(let ek of eN.querySelectorAll("p + blockquote")){let e_=ek.previousElementSibling;e_.querySelector("a.tumblr_blog")&&(e_.dataset.npfUser="",ek.dataset.npfBlockquote="")}if(!eN.querySelector("[data-npf-user]")||!eN.querySelector("[data-npf-blockquote]")){let eC=eM.nextElementSibling,eW=eM.matches(`${i.textBlock} > .npf_inst:first-child`),eO=eM.matches(`${i.textBlock} > :is(h1,h2,p):empty:first-child + .npf_inst`);(eW||eO)&&(eM.classList.add("photo-origin"),u(eP,eM),eN.before(eM),eN.classList.add("npf-caption"),(!eC||eC&&""==eC.innerHTML.trim())&&(eM.classList.add("npf-no-caption"),""==eN.innerHTML.trim()&&eN.remove()))}if(!eN.matches(".npf-caption"))for(let eF of eN.querySelectorAll("[data-npf-user] + [data-npf-blockquote]:not(:has([data-npf-blockquote]))")){let eB=eF.previousElementSibling;eB.dataset.npfOriginalPoster="",eF.dataset.npfOriginalCaption="";let eR=eM.nextElementSibling,e2=eM.matches("blockquote[data-npf-original-caption] > .npf_inst:first-child"),eI=eM.matches("blockquote[data-npf-original-caption] > :is(h1,h2,p):empty:first-child + .npf_inst");if((e2||eI)&&(eM.classList.add("photo-origin"),u(eP,eM),eN.before(eM),eN.classList.add("npf-caption"),!eR||eR&&""==eR.innerHTML.trim())){if(eM.classList.add("npf-no-caption"),"yes"==i.addSource||!0===i.addSource){let ej=eB.querySelector("a.tumblr_blog").cloneNode(!0);if(""!==ej.textContent.trim()){let eQ=document.createElement("p");eQ.classList.add("npf-post-source"),eQ.append(ej),eQ.innerHTML=`(Source: ${eQ.innerHTML})`,eN.append(eQ)}}eB.remove(),eF.remove(),""==eN.innerHTML.trim()&&eN.remove()}}}}let e0=document.querySelectorAll(`${o}`),e1=[];e0?.forEach((t,o)=>{t.classList.add("npf-loaded"),e1.push(t),o==e0.length-1&&e?.(e1)})};r(()=>{i(e);if((window.jQuery||window.$)&&$().infinitescroll||"undefined"!=typeof InfiniteScroll&&!document.documentElement.hasAttribute("has-infinite-scroll")){document.documentElement.setAttribute("has-infinite-scroll","");let t=document.querySelectorAll("[post-type]").length;new MutationObserver(()=>{let o=document.querySelectorAll("[post-type]").length;o>t&&(t=o,i(e))}).observe(document.body,{childList:!0,subtree:!0})}})};