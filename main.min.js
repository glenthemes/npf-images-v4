/*
    NPF images fix v4.0 by @glenthemes [2026]
    github.com/glenthemes/npf-images-v4
*/
window.NPFv4=e=>{let t=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),o="[post-type]:not(.npf-loaded)",l="[post-type='text']:not(.npf-loaded)";function r(e){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}function i(e){let t=getComputedStyle(document.documentElement).getPropertyValue(e).trim().replace(/^['"]|['"]$/g,"");return""===t?void 0:t}let n=e=>{function r(){return{textBlock:i("--NPF-Text-Container")??"",reblogs:i("--NPF-Reblogs-Selector")??"",moveToTop:i("--NPF-Move-To-Top")??"no",addSource:i("--NPF-Captionless-Add-Source")??"yes",changePostType:i("--NPF-Change-Post-Type")??"no"}}let n=r();function s(e,t,o,l){let r=[],i=e.querySelectorAll(`:scope > ${t}`),n=0,s=i.length;i?.forEach(e=>{if(!e.previousElementSibling?.matches(t)){let i=document.createElement(o.tag);if(Array.isArray(o.className))for(let p of o.className)i.classList.add(p);else i.classList.add(o.className);e.before(i);let c=i.nextElementSibling;for(c&&(!c||c.matches(t))||i.remove(),c&&r.push(i);c&&c.matches(t);)i.append(c),c=i.nextElementSibling}++n===s&&l&&"function"==typeof l&&l(r)})}function p(e){return""!==e&&null!==document.querySelector(e)}function c(e,t){let o=document.createElement("div");if(o.classList.add("npf_col"),!e||!e.wrap)return o;e.wrap.before(o),o.append(e.wrap),t?.(o)}function d(e,t){let o=document.createElement("div");if(o.classList.add("tmblr-full"),!e||!e.wrap)return o;e.wrap.before(o),o.append(e.wrap),t?.(o)}function f(e,t){let o=t.addType,l;!e.matches(".tmblr-full")&&e.closest(".tmblr-full")?l=e.closest(".tmblr-full"):e.matches(".tmblr-full")||e.closest(".tmblr-full")?l=e:d({wrap:e},e=>{l=e}),l.closest(".npf_row")||h({wrap:l,addType:o})}function h(e,t){let o=document.createElement("div");if(o.classList.add("npf_row"),e&&e.addType){if(Array.isArray(e.addType))for(let l of e.addType)o.classList.add(`npf_${l}`);else o.classList.add(`npf_${e.addType}`)}if(!e||!e.wrap)return o;e.wrap.before(o),o.append(e.wrap),t?.(o)}function u(e,t){if(e&&t&&n.changePostType&&("yes"==n.changePostType||!0===n.changePostType)){let o=t.getAttribute("class");e.setAttribute("post-type",o.indexOf("npf_photo")>-1?"photo":o.indexOf("npf_audio")>-1?"audio":o.indexOf("npf_video")>-1?"video":o.indexOf("npf_multimedia")>-1?"multimedia":"text"),e.classList.add("previously-npf")}}function m(){"aspect-ratio"in document.documentElement.style?g?.():y?.()}function g(){document.querySelectorAll(".npf_photo_row:not(.npf-loaded [data-npf-row-ready]):has(.npf_col + .npf_col)")?.forEach(e=>{let t=[],o=[],l=".npf_col:not(.npf_col .npf_col)";if(e.querySelectorAll(l)?.forEach(e=>{let l=e.querySelector("[data-big-photo-width][data-big-photo-height]")||e.querySelector("[data-orig-width][data-orig-height]");if(l){let r;if(l.matches("[data-big-photo-width][data-big-photo-height]")?r="big-photo":l.matches("[data-orig-width][data-orig-height]")&&(r="orig"),l&&""!==l.getAttribute(`data-${r}-width`).trim()&&""!==l.getAttribute(`data-${r}-height`).trim()){let i=Number(l.getAttribute(`data-${r}-width`)),n=Number(l.getAttribute(`data-${r}-height`));if(isNaN(i)||isNaN(n))return;t.push(i/n),o.push(`${i}/${n}`)}}}),t.length==e.querySelectorAll(l).length){let r=Math.max(...t),i=o[t.findIndex(e=>e===r)];e.querySelectorAll(l)?.forEach(e=>e.style.aspectRatio=i),e.dataset.npfRowReady=""}})}function y(){document.querySelectorAll(".npf_photo_row[columns]:not(.npf-loaded [data-npf-row-ready], [columns='1'], [columns=''], [columns='0'])")?.forEach(e=>{let t=e.querySelectorAll(":scope > .npf_col").length,o=[],l=[],r=[];e.querySelectorAll(":scope > .npf_col img:first-of-type")?.forEach(i=>{let n,s,p;function c(i,n,s){if(o.push(i),l.push(n),r.push(s),o.length==t){let p=Math.max(...r),c=r.findIndex(e=>e==p),d=o[c],f=l[c];e.style.setProperty("--npf-img-pct",`${f/d*100}%`),e.dataset.npfHeight="",e.dataset.npfRowReady=""}}i.complete?(p=(n=i.naturalWidth)/(s=i.naturalHeight),c(n,s,p)):i.addEventListener("load",e=>{p=(n=e.target.naturalWidth)/(s=e.target.naturalHeight),c(n,s,p)})})})}function b(e,t){let o=e.nextElementSibling;!o||o&&""==o.innerHTML.trim()?t.remove():e.remove()}if(!document.querySelector("[post-type='text']")&&document.querySelector('script[src*="assets.tumblr.com/assets/scripts/customize"]')&&!document.getElementById("npf-v4-reminder")){let w=document.createElement("div");if(w.id="npf-v4-reminder",w.innerHTML='<b>NPF v4</b> warning: <code>post-type="{PostType}"</code> does not appear to be present in your theme. <a href="https://github.com/glenthemes/npf-images-v4?tab=readme-ov-file#step-3-add-post-typeposttype-to-your-posts" target="_blank">Please add it to your posts selector</a> to get it working!',!document.querySelector('link[href*="//assets.tumblr.com/fonts/favorit/stylesheet.css"][rel="stylesheet"]')){let S=document.createElement("link");S.href="https://assets.tumblr.com/fonts/favorit/stylesheet.css",S.rel="stylesheet",document.head.append(S)}document.body.append(w)}for(let L of document.querySelectorAll(`${o} p > br:only-child`))[...L.closest("p").childNodes]?.forEach(e=>{if(3===e.nodeType&&e.data.trim().length){let t=document.createElement("span");e.before(t),t.appendChild(e)}});for(let q of document.querySelectorAll(`${o} p`))""==q.innerHTML.trim()&&q.remove();for(let v of document.querySelectorAll(`${o} figure:not([class])`))v.querySelector("img")&&v.classList.add("tmblr-full");for(let A of document.querySelectorAll(`${o} .npf_row .tmblr-full:not(:only-of-type):not(.npf_col > .tmblr-full)`))c({wrap:A});for(let T of document.querySelectorAll(`${o} [data-npf*='"type":"video"'], ${o} .tmblr-embed.tmblr-full`))f(T,{addType:"video_row"});for(let E of document.querySelectorAll(`${l} .vidyo-video-container`))E.closest(".npf_video_row")||h({wrap:E,addType:"video_row"});for(let x of document.querySelectorAll(`${o} [data-npf*='"type":"audio"'], ${o} iframe[class*="_audio_player"], ${o} .tmblr-full > figcaption.audio-caption`))f(x,{addType:"audio_row"});for(let H of document.querySelectorAll(`${o} .npf-audio-wrapper`))H.closest(".npf_audio_row")||h({wrap:H,addType:"audio_row"});for(let M of document.querySelectorAll(`${o} figure[data-orig-src] > img:first-child`)){let P=M.closest("figure[data-orig-src]");if(P.matches(".tmblr-full")||P.classList.add("tmblr-full"),M.matches("[data-orig-width][data-orig-height]")){let N=M.dataset.origWidth,k=M.dataset.origHeight,_=document.createElement("a");_.classList.add("post_media_photo_anchor"),_.dataset.bigPhoto=M.src,_.dataset.bigPhotoWidth=N,_.dataset.bigPhotoHeight=k,M.classList.add("post_media_photo","image"),M.before(_),_.append(M)}P.closest(".npf_row")||h({wrap:P,addType:"photo_row"})}for(let C of document.querySelectorAll(`${o} .tmblr-full:not(.npf_row .tmblr-full) > a.post_media_photo_anchor > img.post_media_photo`))h({wrap:C.closest(".tmblr-full:not(.npf_row .tmblr-full)"),addType:"photo_row"});for(let W of document.querySelectorAll(`${o} .tmblr-full[data-tumblr-attribution] > img`)){let O=W.closest(".tmblr-full");W.matches(".post_media_image")||W.classList.add("post_media_image");let F;if(!W.closest("a.post_media_photo_anchor")&&O.matches("[data-orig-width]:not([data-orig-width=''])[data-orig-height]:not([data-orig-height=''])")){let B=document.createElement("a");B.classList.add("post_media_photo_anchor"),B.dataset.bigPhotoWidth=O.dataset.origWidth,B.dataset.bigPhotoHeight=O.dataset.origHeight,O.before(B),B.append(O),F=B}else F=a;F.closest(".npf_row")?F.closest(".npf_row").classList.add("npf_photo_row"):h({wrap:F,addType:"photo_row"})}for(let R of document.querySelectorAll(`${o} .npf_row > .npf_col:only-child`))R.replaceWith(...R.childNodes);for(let I of document.querySelectorAll(`${o} .npf_row > .npf_col + .npf_col`))I.closest(".npf_row").classList.add("npf_photo_row");for(let j of document.querySelectorAll(`${o} .npf_row > .tmblr-full > a.post_media_photo_anchor > img.post_media_photo`))j.closest(".npf_row").classList.add("npf_photo_row");let Q=["npf_photo_row","npf_video_row","npf_audio_row"];for(let z of document.querySelectorAll(`${o} .npf_row:first-of-type:not(.npf_row .npf_row, .npf_inst .npf_row)`)){let D=z.parentNode;D&&s(D,".npf_row",{tag:"div",className:"npf_inst"},e=>{for(let t of e){let o=[];for(let l of t.children)l.matches(".npf_row")&&o.push(l.classList.value.split(" ").filter(e=>"npf_row"!==e));if(1==o.length){let r=o[0];for(let i of Q)r.includes(i)&&(t.classList.add(i.substring(0,i.lastIndexOf("_row"))+(t.querySelector(".npf_col")?"_set":"_single")),r=r.filter(e=>e!==i))}else if(o.length>1)for(let n=0;n<o.length-1;n++){let p=o[n],c=o[n+1],d=p.filter(e=>c.includes(e));d.length?"npf_photo_row"==d[0]?t.classList.add("npf_photo_set"):"npf_audio_row"==d[0]?t.classList.add("npf_audio_set"):"npf_video_row"==d[0]&&t.classList.add("npf_video_set"):(t.classList.add("npf_multimedia"),s(t,".npf_photo_row",{tag:"div",className:["npf_row_set","npf_photo_set"]}))}}})}for(let U of document.querySelectorAll(`${o} .npf_row.npf_photo_row`)){let V=U.querySelectorAll(".npf_col:not(.npf_col .npf_col)")?.length;U.setAttribute("columns",V||1)}for(let G of(m(),document.querySelectorAll(`${o} .npf_col`)))G.dataset.ready="";for(let J of document.querySelectorAll(`${o} .npf_photo_set, ${o} .npf_photo_single`))if(J.querySelector("img")){let K=[];J.querySelectorAll("img").forEach((e,o)=>{let l=e.closest("a.post_media_photo_anchor");l&&l.matches("[data-big-photo]")&&l.removeAttribute("data-big-photo");let r,i,n,s;if(e.matches("[srcset]")){let p=e.getAttribute("srcset");n=e.src,s=p.split(",").pop().trim().split(" ")[0];let c=new Image;c.src=s,r=c.width,i=c.height,r>=.9*t&&(r*=.7,i*=.7)}else{n=e.src,s=e.src;let d=e.closest("[data-big-photo-width]"),f=e.closest("[data-big-photo-height]");r=d?Number(d.getAttribute("data-big-photo-width")):e.width,i=f?Number(f.getAttribute("data-big-photo-height")):e.height}K.push({width:r,height:i,low_res:n,high_res:s});let h=Math.floor(parseInt(o)+1);e.setAttribute("img-index",h),e.addEventListener("click",()=>{Tumblr.Lightbox.init(K,h)})})}if("yes"==n.moveToTop||!0===n.moveToTop){let X=n.textBlock,Y=p(X),Z=n.reblogs,ee=p(Z);if((window.jQuery||window.$)&&$().unnest){if(ee||document.querySelector(".tumblr_parent"),Y&&!p(Z))for(let et of document.querySelectorAll(`${l} ${X} .npf_inst`)){let eo=et.closest("[post-type='text']"),el=et.previousElementSibling,er=et.nextElementSibling,ei=et.closest(X);(!el||el&&""==el.innerHTML.trim())&&(et.classList.add("photo-origin"),u(eo,et),ei.before(et),ei.classList.add("npf-caption"),(!er||er&&""==er.innerHTML.trim())&&(et.classList.add("npf-no-caption"),ei.remove()))}else if(p(Z))for(let ea of document.querySelectorAll(`${l} ${Z}:not(:is(${Z} ~ ${Z})) .npf_inst`)){let en=ea.closest("[post-type='text']"),es=Y?ea.closest(X):ea.closest(Z),ep=ea.closest(Z),ec=ea.previousElementSibling,ed=ea.nextElementSibling,ef=ec&&""==ec.innerHTML.trim(),eh=ec&&(ec.matches("a.tumblr_blog")||ec.matches("a[href*='tumblr.com/']"));if((!ec||ef||eh)&&(ea.classList.add("photo-origin"),u(en,ea),es.before(ea),es.classList.add("npf-caption"),!ed||ed&&""==ed.innerHTML.trim())){if(ea.classList.add("npf-no-caption"),"yes"==n.addSource||!0===n.addSource){let eu=es.querySelector("a[href*='tumblr.com/']");if(eu){let em=document.createElement("a");if(em.href=eu.href,em.textContent=eu.textContent,""!==em.textContent.trim()){let eg=document.createElement("p");(eg.classList.add("npf-post-source"),eg.append(em),eg.innerHTML=`(Source: ${eg.innerHTML})`,es!==ep)?(es.after(eg),b(ep,es)):(ep.parentNode.after(eg),ep.remove())}}}else b(ep,es)}}}else if(Z){if(Z)for(let e8 of document.querySelectorAll(`${l} .npf_inst`)){let ey=e8.closest("[post-type='text']");if(e8.closest(Z)){let eb=Y?e8.closest(X):e8.closest(Z),ew=e8.closest(Z);if(ew.matches(`${l} ${Z}:not(:is(${Z} ~ ${Z}))`)){let eS=e8.previousElementSibling,eL=e8.nextElementSibling,eq=eS&&""==eS.innerHTML.trim(),ev=eS&&(eS.matches("a.tumblr_blog")||eS.matches("a[href*='tumblr.com/']"));if((!eS||eq||ev)&&!ey.querySelector(".photo-origin")&&(e8.classList.add("photo-origin"),u(ey,e8),eb.before(e8),eb.classList.add("npf-caption"),!eL||eL&&""==eL.innerHTML.trim())){let e9=ew.querySelector("a[href*='tumblr.com/']");if(e8.classList.add("npf-no-caption"),"yes"==n.addSource||!0===n.addSource){if(e9){let eA=document.createElement("a");if(eA.href=e9.href,eA.textContent=e9.textContent,""!==eA.textContent.trim()){let eT=document.createElement("p");if(eT.classList.add("npf-post-source"),eT.append(eA),eT.innerHTML=`(Source: ${eT.innerHTML})`,eb!==ew)eb.append(eT),ew.remove();else{let eE=ew.parentNode.querySelector(`:scope > ${Z}:not(:has(~ ${Z}))`);eE&&(eE.after(eT),ew.remove())}}}}else{let ex=ew.nextElementSibling;!ex||ex&&""==ex.innerHTML.trim()?eb!==ew?eb.remove():ew.parentNode.querySelectorAll(`:scope > ${Z}`)?.forEach(e=>e.remove()):ew.remove()}}}}else{""==X&&(X=".text");let eH=e8.closest(X);if(eH){let e$=e8.previousElementSibling,eM=e8.nextElementSibling,eP=e$&&""==e$.innerHTML.trim(),eN=e$&&(e$.matches("a.tumblr_blog")||e$.matches("a[href*='tumblr.com/']"));(!e$||eP||eN)&&(e8.classList.add("photo-origin"),u(ey,e8),eH.before(e8),eH.classList.add("npf-caption"),(!eM||eM&&""==eM.innerHTML.trim())&&(e8.classList.add("npf-no-caption"),eH.remove()))}}}}else for(let ek of document.querySelectorAll(`${l} .npf_inst`)){let e_=ek.closest("[post-type='text']"),eC=ek.closest(X);if(!eC)return;for(let eW of eC.querySelectorAll("p + blockquote")){let eO=eW.previousElementSibling;eO.querySelector("a.tumblr_blog")&&(eO.dataset.npfUser="",eW.dataset.npfBlockquote="")}if(!eC.querySelector("[data-npf-user]")||!eC.querySelector("[data-npf-blockquote]")){let eF=ek.nextElementSibling,eB=ek.matches(`${n.textBlock} > .npf_inst:first-child`),eR=ek.matches(`${n.textBlock} > :is(h1,h2,p):empty:first-child + .npf_inst`);(eB||eR)&&(ek.classList.add("photo-origin"),u(e_,ek),eC.before(ek),eC.classList.add("npf-caption"),(!eF||eF&&""==eF.innerHTML.trim())&&(ek.classList.add("npf-no-caption"),""==eC.innerHTML.trim()&&eC.remove()))}if(!eC.matches(".npf-caption"))for(let e2 of eC.querySelectorAll("[data-npf-user] + [data-npf-blockquote]:not(:has([data-npf-blockquote]))")){let eI=e2.previousElementSibling;eI.dataset.npfOriginalPoster="",e2.dataset.npfOriginalCaption="";let ej=ek.nextElementSibling,eQ=ek.matches("blockquote[data-npf-original-caption] > .npf_inst:first-child"),e0=ek.matches("blockquote[data-npf-original-caption] > :is(h1,h2,p):empty:first-child + .npf_inst");if((eQ||e0)&&(ek.classList.add("photo-origin"),u(e_,ek),eC.before(ek),eC.classList.add("npf-caption"),!ej||ej&&""==ej.innerHTML.trim())){if(ek.classList.add("npf-no-caption"),"yes"==n.addSource||!0===n.addSource){let e1=eI.querySelector("a.tumblr_blog").cloneNode(!0);if(""!==e1.textContent.trim()){let e5=document.createElement("p");e5.classList.add("npf-post-source"),e5.append(e1),e5.innerHTML=`(Source: ${e5.innerHTML})`,eC.append(e5)}}eI.remove(),e2.remove(),""==eC.innerHTML.trim()&&eC.remove()}}}}let ez=document.querySelectorAll(`${o}`),eD=[];ez?.forEach((t,o)=>{t.classList.add("npf-loaded"),eD.push(t),o==ez.length-1&&e?.(eD)})};r(()=>{n(e);if((window.jQuery||window.$)&&$().infinitescroll||"undefined"!=typeof InfiniteScroll&&!document.documentElement.hasAttribute("has-infinite-scroll")){document.documentElement.setAttribute("has-infinite-scroll","");let t=document.querySelectorAll("[post-type]").length;new MutationObserver(()=>{let o=document.querySelectorAll("[post-type]").length;o>t&&(t=o,n(e))}).observe(document.body,{childList:!0,subtree:!0})}})};